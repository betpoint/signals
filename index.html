<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signal Alerts â€” Bet Point</title>

 <!-- iOS home screen icon -->
<link rel="apple-touch-icon" href="icon-512x512.png">

<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.json">

<meta name="theme-color" content="#000000">

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
      background: #000;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* LOGIN OVERLAY */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: #ffffff;
    }

    #loginOverlay img {
      width: 96px;
      height: 96px;
      margin-bottom: 16px;
    }

    #loginOverlay h2 {
      margin-bottom: 20px;
      font-weight: 600;
    }

    #loginOverlay input {
      padding: 12px;
      font-size: 16px;
      width: 220px;
      border-radius: 6px;
      border: none;
      margin-bottom: 12px;
    }

    #loginOverlay button {
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: #ffffff;
      cursor: pointer;
    }

    #loginOverlay button:hover {
      background: #005fcc;
    }

    #loginError {
      color: #ff4d4d;
      margin-top: 12px;
    }

    /* LOADING SPINNER */
    #loadingSpinner {
      width: 36px;
      height: 36px;
      border: 4px solid #333;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-top: 16px;
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    let rowId = null;
    let linkId = null;
    let playerId = null;
    let registered = false;

    const deviceType = /Mobi|Android/i.test(navigator.userAgent)
      ? 'mobile'
      : 'web';

    const VERIFY_URL =
      'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/verify-link';

    const REGISTER_URL =
      'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/register-device';

    const APP_URL =
      'https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true';

    /* AUTO LOGIN */
    window.addEventListener('DOMContentLoaded', async () => {
      const savedLink = localStorage.getItem('linkId');
      if (!savedLink) return;

      try {
        const res = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ link_id: savedLink })
        });

        const data = await res.json();
        if (data.valid) {
          linkId = savedLink;
          rowId = data.row_id;
          unlockApp();
          initOneSignal();
        } else {
          localStorage.removeItem('linkId');
        }
      } catch {
        localStorage.removeItem('linkId');
      }
    });

    /* LOGIN SUBMIT */
    async function submitRowId() {
      const input = document.getElementById('rowIdInput');
      const spinner = document.getElementById('loadingSpinner');
      const error = document.getElementById('loginError');

      rowId = input.value.trim();
      if (!rowId) return;

      error.textContent = '';
      spinner.style.display = 'block';

      try {
        const res = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ row_id: rowId })
        });

        const data = await res.json();

        if (data.valid) {
          linkId = data.link_id;
          localStorage.setItem('linkId', linkId);
          unlockApp();
          initOneSignal();
        } else {
          error.textContent = 'Invalid password.';
        }
      } catch {
        error.textContent = 'Server error verifying password.';
      } finally {
        spinner.style.display = 'none';
      }
    }

    /* UNLOCK APP */
    function unlockApp() {
      document.getElementById('loginOverlay').style.display = 'none';
      const frame = document.getElementById('appFrame');
      if (!frame.src) frame.src = APP_URL;
    }

    /* ONESIGNAL */
    function initOneSignal() {
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function (OneSignal) {
        await OneSignal.init({
          appId: '2b94ad70-2518-44d4-aaef-bfb95739206f',
          notifyButton: { enable: true }
        });

        const subscribed = await OneSignal.isPushNotificationsEnabled();
        if (subscribed) {
          playerId = await OneSignal.getUserId();
          registerDevice();
        }

        OneSignal.on('subscriptionChange', async (isSubscribed) => {
          if (isSubscribed) {
            playerId = await OneSignal.getUserId();
            registerDevice();
          }
        });
      });
    }

    /* REGISTER DEVICE */
    function registerDevice() {
      if (!rowId || !playerId || registered) return;
      registered = true;

      fetch(REGISTER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rowId, linkId, playerId, deviceType })
      })
      .then(res => res.json())
      .then(console.log)
      .catch(console.error);
    }
  </script>
</head>

<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <img src="./icon-2000x2000.png" alt="Bet Point Logo" />

    <h2>Enter your password</h2>
    <input type="password" id="rowIdInput" placeholder="Password" />
    <button onclick="submitRowId()">Submit</button>
    <div id="loadingSpinner"></div>
    <div id="loginError"></div>
  </div>

  <!-- APP IFRAME (LOCKED UNTIL LOGIN) -->
  <iframe id="appFrame" title="Bet Point Signals App"></iframe>

</body>
</html>







