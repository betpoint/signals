<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Signal Alerts â€” Bet Point</title>

<!-- Web App Manifest -->
<link rel="manifest" href="/manifest.json" />

<!-- iOS home screen icon -->
<link rel="apple-touch-icon" href="/icon-1024x1024.png">

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<!-- OneSignal subscription + login persistence -->
<script>
let rowId = null;
let linkId = null;
let playerId = null;
const deviceType = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'web';

// URLs for your backend
const VERIFY_URL = 'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/verify-link';
const REGISTER_URL = 'https://iznxrukdqbrcxjzhvwyk.supabase.co/functions/v1/register-device';

// Auto-login if already stored
window.addEventListener('DOMContentLoaded', async () => {
  const savedRow = localStorage.getItem('rowId');
  const savedLink = localStorage.getItem('linkId');
  if (savedRow && savedLink) {
    rowId = savedRow;
    linkId = savedLink;
    initOneSignal();
  } else {
    // Show login prompt if you want (or leave empty for now)
    const pwd = prompt("Enter your password to access Bet Point Signals");
    if (pwd) await submitRowId(pwd);
  }
});

// Submit rowId to backend for verification
async function submitRowId(inputValue) {
  rowId = inputValue.trim();
  if (!rowId) return alert('Password required.');

  try {
    const res = await fetch(VERIFY_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ row_id: rowId })
    });
    const data = await res.json();

    if (data.valid) {
      linkId = data.link_id;
      localStorage.setItem('rowId', rowId);
      localStorage.setItem('linkId', linkId);
      initOneSignal();
    } else {
      alert('Invalid password.');
    }
  } catch (err) {
    console.error(err);
    alert('Server error verifying password.');
  }
}

// OneSignal subscription (exactly like your last snippet)
function initOneSignal() {
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "2b94ad70-2518-44d4-aaef-bfb95739206f",
      notifyButton: { enable: false }
    });

    let isSubscribed = await OneSignal.isPushNotificationsEnabled();

    // Prompt if not subscribed
    if (!isSubscribed) await OneSignal.showNativePrompt();

    isSubscribed = await OneSignal.isPushNotificationsEnabled();
    if (isSubscribed) {
      playerId = await OneSignal.getUserId();
      registerDevice();
    }

    OneSignal.on('subscriptionChange', async (subscribed) => {
      if (subscribed) {
        playerId = await OneSignal.getUserId();
        registerDevice();
      }
    });
  });
}

// Register device with backend
function registerDevice() {
  if (!rowId || !playerId) return;
  fetch(REGISTER_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ rowId, playerId, deviceType, linkId })
  })
  .then(res => res.json())
  .then(console.log)
  .catch(console.error);
}

// Register service worker for PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => console.log('Service Worker registered', reg.scope))
    .catch(err => console.warn('SW registration failed', err));
}
</script>

<style>
html, body { margin:0; height:100%; width:100%; font-family:Arial,sans-serif; }
body { display:flex; flex-direction:column; background:#000; color:#fff; }
iframe { flex:1; border:none; width:100%; height:100%; }
</style>
</head>

<body>
  <!-- Embedded Appsmith App -->
  <iframe src="https://bet-point.appsmith.com/app/signals/page1-68b217383a43874978908b5c?embed=true" 
          title="Bet Point Signals App">
  </iframe>
</body>
</html>



